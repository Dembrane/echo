[
  {
    "name": "Check Language",
    "key": "check_language",
    "type": "condition",
    "position_x": 20,
    "position_y": 1,
    "options": {
      "filter": {
        "$trigger": {
          "language": {
            "_eq": "en"
          }
        }
      }
    },
    "resolve": "5f9aad15-ff17-4cb5-8ab8-e9ef169470fd",
    "reject": "435e2a60-3c92-4225-91aa-45156884ac2b",
    "flow": "17703446-fef0-49e9-bdc4-385db1311137",
    "_syncId": "11fdc301-7101-40f3-bc82-af3b472fd914"
  },
  {
    "name": "Check Report Language",
    "key": "check_report_language",
    "type": "item-read",
    "position_x": 73,
    "position_y": 1,
    "options": {
      "query": {
        "filter": {
          "project_id": {
            "id": {
              "_eq": "{{$trigger.payload.project_id.id}}"
            }
          }
        },
        "fields": [
          "language"
        ]
      },
      "collection": "project_report"
    },
    "resolve": "6fba7361-0b76-40b0-b4ae-ef094d896bb6",
    "reject": null,
    "flow": "ec4e7ea5-72de-4365-b66f-d8f11b549495",
    "_syncId": "7be4966b-477b-4961-a341-26c663f9d27a"
  },
  {
    "name": "Dutch",
    "key": "dutch",
    "type": "condition",
    "position_x": 20,
    "position_y": 20,
    "options": {
      "filter": {
        "$trigger": {
          "language": {
            "_eq": "nl"
          }
        }
      }
    },
    "resolve": "21b8e36a-a71d-4912-b428-9ee67c1df1ba",
    "reject": "13856746-f10a-402a-bf4b-68a4213b6c21",
    "flow": "17703446-fef0-49e9-bdc4-385db1311137",
    "_syncId": "435e2a60-3c92-4225-91aa-45156884ac2b"
  },
  {
    "name": "Email Send Operation Failed",
    "key": "email_send_operation_failed",
    "type": "log",
    "position_x": 58,
    "position_y": 1,
    "options": {
      "message": "An email could not be sent due to some error: {{$last}}"
    },
    "resolve": null,
    "reject": null,
    "flow": "17703446-fef0-49e9-bdc4-385db1311137",
    "_syncId": "16319ea2-0cdf-4e50-9e83-d62cd9f29d71"
  },
  {
    "name": "Email Send Operation Failed Dutch",
    "key": "email_send_operation_failed_dutch",
    "type": "log",
    "position_x": 58,
    "position_y": 20,
    "options": {
      "message": "An email could not be sent due to some error: {{$last}}"
    },
    "resolve": null,
    "reject": null,
    "flow": "17703446-fef0-49e9-bdc4-385db1311137",
    "_syncId": "97bc1561-dd12-4fbf-9ebd-4b44c06d4fb9"
  },
  {
    "name": "failed",
    "key": "failed",
    "type": "log",
    "position_x": 20,
    "position_y": 39,
    "options": {
      "message": "language detection failed"
    },
    "resolve": null,
    "reject": null,
    "flow": "17703446-fef0-49e9-bdc4-385db1311137",
    "_syncId": "13856746-f10a-402a-bf4b-68a4213b6c21"
  },
  {
    "name": "Filter Emails",
    "key": "filter_emails",
    "type": "exec",
    "position_x": 91,
    "position_y": 1,
    "options": {
      "code": "module.exports = async function(data) {\n\n    const submissions = data.get_all_participants;\n    \n    // Filter submissions to only include those where email_opt_in is true\n    const filteredSubmissions = submissions.filter(sub => sub.email_opt_in === true);\n\n    // Create an array with email, project_id and an email_opt_out token for each submission\n    const result = filteredSubmissions.map(sub => ({\n        project_name: data.project_data[0].name || '',\n\t\tdefault_conversation_title: data.project_data[0].default_conversation_title || '',\n\t\tconversation_name: sub.conversation_id.participant_name || '',\n        email: sub.email,\n        project_id: sub.project_id || '',\n        token: sub.email_opt_out_token,\n        language: data.check_report_language[0].language || 'empty',\n        ADMIN_BASE_URL: \"{{ $env.ADMIN_BASE_URL }}\" || \"http://localhost:5173\",\n        PARTICIPANT_BASE_URL: \"{{ $env.PARTICIPANT_BASE_URL }}\" || \"http://localhost:5174\",        \n    }));\n    \n    return result;\n};"
    },
    "resolve": "b10f5a01-3355-4884-8e37-308caf3c56d7",
    "reject": null,
    "flow": "ec4e7ea5-72de-4365-b66f-d8f11b549495",
    "_syncId": "6fba7361-0b76-40b0-b4ae-ef094d896bb6"
  },
  {
    "name": "Get All Participants",
    "key": "get_all_participants",
    "type": "item-read",
    "position_x": 55,
    "position_y": 1,
    "options": {
      "query": {
        "filter": {
          "project_id": {
            "id": {
              "_eq": "{{$trigger.payload.project_id}}"
            }
          }
        },
        "fields": [
          "*",
          "conversation_id.participant_name"
        ]
      },
      "collection": "project_report_notification_participants"
    },
    "resolve": "7be4966b-477b-4961-a341-26c663f9d27a",
    "reject": null,
    "flow": "ec4e7ea5-72de-4365-b66f-d8f11b549495",
    "_syncId": "dad81699-20ef-435d-a3e3-a7c09ed97c42"
  },
  {
    "name": "log environment vars",
    "key": "log_environment_vars",
    "type": "log",
    "position_x": 127,
    "position_y": 1,
    "options": {
      "message": "{{data['$env']}}  {{data.$env}} {{process.env}} {{$env}} {{$env.PARTICIPANT_BASE_URL}}"
    },
    "resolve": null,
    "reject": null,
    "flow": "ec4e7ea5-72de-4365-b66f-d8f11b549495",
    "_syncId": "9c98061e-46a1-4947-804d-0cddfdf05b69"
  },
  {
    "name": "PROCEED_ONLY_IF \"published\" in payload",
    "key": "proceed_only_if_published_in_payload",
    "type": "condition",
    "position_x": 19,
    "position_y": 1,
    "options": {
      "filter": {
        "$trigger": {
          "payload": {
            "status": {
              "_eq": "published"
            }
          }
        }
      }
    },
    "resolve": "57fb6535-6c26-413d-858d-9ccf89846205",
    "reject": "60af30e5-dd72-422c-b51c-8bff6d5bc614",
    "flow": "ec4e7ea5-72de-4365-b66f-d8f11b549495",
    "_syncId": "cb0759e3-a837-4f4b-9f61-276f17958f2b"
  },
  {
    "name": "Project Data",
    "key": "project_data",
    "type": "item-read",
    "position_x": 37,
    "position_y": 1,
    "options": {
      "collection": "project",
      "query": {
        "filter": {
          "id": {
            "id": {
              "_eq": "{{$trigger.payload.project_id}}"
            }
          }
        }
      }
    },
    "resolve": "dad81699-20ef-435d-a3e3-a7c09ed97c42",
    "reject": null,
    "flow": "ec4e7ea5-72de-4365-b66f-d8f11b549495",
    "_syncId": "57fb6535-6c26-413d-858d-9ccf89846205"
  },
  {
    "name": "Report Not Published",
    "key": "report_not_published",
    "type": "log",
    "position_x": 19,
    "position_y": 19,
    "options": {
      "message": "The report is not yet published"
    },
    "resolve": null,
    "reject": null,
    "flow": "ec4e7ea5-72de-4365-b66f-d8f11b549495",
    "_syncId": "60af30e5-dd72-422c-b51c-8bff6d5bc614"
  },
  {
    "name": "Send Email Dutch",
    "key": "send_email_dutch",
    "type": "mail",
    "position_x": 39,
    "position_y": 20,
    "options": {
      "to": [
        "{{$trigger.email}}"
      ],
      "type": "template",
      "subject": "Er is een rapport klaar met uw inbreng",
      "body": null,
      "data": {
        "PARTICIPANT_BASE_URL": "{{$trigger.PARTICIPANT_BASE_URL}}",
        "project_id": "{{$trigger.project_id}}",
        "project_name": "{{$trigger.project_name}}",
        "default_conversation_title": "{{$trigger.default_conversation_title}}",
        "conversation_name": "{{$trigger.conversation_name}}",
        "token": "{{$trigger.token}}"
      },
      "template": "report-notification-nl",
      "replyTo": [
        "info@dembrane.com"
      ]
    },
    "resolve": null,
    "reject": "97bc1561-dd12-4fbf-9ebd-4b44c06d4fb9",
    "flow": "17703446-fef0-49e9-bdc4-385db1311137",
    "_syncId": "21b8e36a-a71d-4912-b428-9ee67c1df1ba"
  },
  {
    "name": "Send Email English",
    "key": "send_email_english",
    "type": "mail",
    "position_x": 39,
    "position_y": 1,
    "options": {
      "to": [
        "{{$trigger.email}}"
      ],
      "subject": "A Report Featuring Your Input is Ready",
      "body": null,
      "type": "template",
      "template": "report-notification-en",
      "data": {
        "PARTICIPANT_BASE_URL": "{{$trigger.PARTICIPANT_BASE_URL}}",
        "project_id": "{{$trigger.project_id}}",
        "project_name": "{{$trigger.project_name}}",
        "default_conversation_title": "{{$trigger.default_conversation_title}}",
        "conversation_name": "{{$trigger.conversation_name}}",
        "token": "{{$trigger.token}}"
      },
      "replyTo": [
        "info@dembrane.com"
      ]
    },
    "resolve": null,
    "reject": "16319ea2-0cdf-4e50-9e83-d62cd9f29d71",
    "flow": "17703446-fef0-49e9-bdc4-385db1311137",
    "_syncId": "5f9aad15-ff17-4cb5-8ab8-e9ef169470fd"
  },
  {
    "name": "Trigger Email Flow",
    "key": "trigger_email_flow",
    "type": "trigger",
    "position_x": 109,
    "position_y": 1,
    "options": {
      "flow": "17703446-fef0-49e9-bdc4-385db1311137",
      "iterationMode": "serial",
      "payload": "{{filter_emails}}"
    },
    "resolve": null,
    "reject": null,
    "flow": "ec4e7ea5-72de-4365-b66f-d8f11b549495",
    "_syncId": "b10f5a01-3355-4884-8e37-308caf3c56d7"
  }
]
